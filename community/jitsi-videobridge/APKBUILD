# Contributor:
# Maintainer:
pkgname=jitsi-videobridge
pkgver=4548
pkgrel=0
pkgdesc="jitsi-videobridge"
url="https://jitsi.org"
arch="all"
license="apache-2.0"
depends="openjdk8-jre"
makedepends="openjdk8-jre maven openjdk8"
install="$pkgname.pre-install $pkgname.post-install"
subpackages=""
source="
	https://github.com/jitsi/jitsi-videobridge/archive/stable/jitsi-meet_${pkgver}.zip
	jitsi-videobridge.initd
	jitsi-videobridge.confd
	"

build() {
	cd "jitsi-videobridge-stable-jitsi-meet_${pkgver}"
	mvn -B package --file pom.xml
	unzip target/jitsi-videobridge-2.1-SNAPSHOT-archive.zip
}

check() {
	echo wip
	# cd "jitsi-videobridge-stable-jitsi-meet_${pkgver}"
}

package() {
	# cd "jitsi-videobridge-stable-jitsi-meet_${pkgver}"
	target="$srcdir/jitsi-videobridge-stable-jitsi-meet_${pkgver}"

	mkdir -p $pkgdir/usr/share/jitsi-videobridge
	mkdir -p $pkgdir/usr/share/jitsi-videobridge/lib
	install -m544 "$target"/jitsi-videobridge-2.1-SNAPSHOT/jitsi-videobridge.jar \
		"$pkgdir"/usr/share/jitsi-videobridge/jitsi-videobridge.jar
	install -m544 "$target"/jitsi-videobridge-2.1-SNAPSHOT/jvb.sh \
		"$pkgdir"/usr/share/jitsi-videobridge
	install -m444 "$target"/jitsi-videobridge-2.1-SNAPSHOT/lib/*.jar \
		"$pkgdir"/usr/share/jitsi-videobridge/lib/

	mkdir -p $pkgdir/usr/share/jitsi-videobridge/sysctl.d
	install -m444 $target/config/20-jvb-udp-buffers.conf \
		$pkgdir/usr/share/jitsi-videobridge/sysctl.d/jitsi-videobridge.conf 

	mkdir -p $pkgdir/usr/share/jitsi-videobridge/logrotate.d
	install -m444 $target/config/logrotate \
		$pkgdir/usr/share/jitsi-videobridge/logrotate.d/jitsi-videobridge.conf

	mkdir -p $pkgdir/etc/jitsi/videobridge
	install -m444 $target/lib/logging.properties \
		$pkgdir/etc/jitsi/videobridge/
	install -m444 $target/config/log4j2.xml \
		$pkgdir/etc/jitsi/videobridge/
	install -m444 $target/config/callstats-java-sdk.properties \
		$pkgdir/etc/jitsi/videobridge/

	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="fce763a437117d47ecb88938e6a1c448e71da93317650f1990a39553e49951893f0744fa44a6f45fc66a5afad51ade24312b5c9cc27720eb017d9dbbb650ffc1  jitsi-meet_4548.zip
87caa38f254264c35ef0602b41c81c77455994da07d13eff7b204a4b31646617a8febf74ef5b736fef1dc1054c48e1df3d5a4af0c8d2545082b734fde2db0ab2  jitsi-videobridge.initd
05a05d13320a66c35c277816d937663addf3912b940ebc872a318a7948fcb65fdc05cd774e14fbd4c9cea54e37c339f7c77b2f87d2410df9699a8d55873daa1b  jitsi-videobridge.confd"
